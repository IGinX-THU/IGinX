name: "iotdb12"
description: "setup iotdb12"
inputs:
    version:
        description: "iotdb version"
        required: false
        default: "0.12.6"

runs:
    using: "composite"
    steps:
        - id: base
          name: Initialize Setup Configuration
          uses: ./.github/actions/setup/tool
          with:
              tool: iotdb
              version: ${{ inputs.version }}

        - name: Restore iotdb Cache
          id: restore
          uses: actions/cache/restore@v3
          with:
              path: ${{ steps.base.outputs.cache-path }}
              key: ${{ steps.base.outputs.cache-key }}

        - name: Cache iotdb
          uses: actions/cache@v3
          with:
              path: ${{ steps.base.outputs.cache-path }}
              key: ${{ steps.base.outputs.cache-key }}

        - name: Setup iotdb into Runner Tool Cache
          uses: pbrisbin/setup-tool-action@v2
          with:
              name: iotdb
              version: 0.12.6
              url: "https://github.com/thulab/IginX-benchmarks/raw/main/resources/apache-iotdb-0.12.6-server-bin.zip"
              subdir: "apache-iotdb-0.12.6-server-bin"
              ext: "zip"

        - name: Add iotdb ROOT to ENV
          shell: bash
          working-directory: ${{ steps.base.outputs.tool-path }}
          run: echo "IOTDB_ROOT=$PWD" >> $GITHUB_ENV

        - name: Save iotdb Cache
          if: steps.restore.outputs.cache-hit != 'true'
          uses: actions/cache/save@v3
          with:
              path: ${{ steps.base.outputs.cache-path }}
              key: ${{ steps.base.outputs.cache-key }}

        - name: save old JAVA_HOME and PATH
          id: old-env
          shell: bash
          run: |
              echo "oldJavaHome=$JAVA_HOME" >> $GITHUB_OUTPUT
              echo "oldPath=$PATH" >> $GITHUB_OUTPUT

        - uses: actions/setup-java@v4
          with:
              java-version: 8
              distribution: ${{ runner.os == 'macOS' && 'liberica' || 'temurin' }}

        - name: restore old JAVA_HOME and PATH
          id: java8-home
          shell: bash
          run: |
              echo "JAVA_HOME=${{ steps.old-env.outputs.oldJavaHome }}" >> $GITHUB_ENV
              echo "PATH=${{ steps.old-env.outputs.oldPath }}" >> $GITHUB_ENV

        - name: Add JAVA_HOME of Java 8 to IoTDB Scripts
          if: runner.os != 'Windows'
          shell: bash
          working-directory: ${{ steps.base.outputs.tool-path }}
          run: |
              perl -i -pe 'print "JAVA_HOME=$JAVA_HOME_8_${{ runner.arch }}\n" if $. == 20' sbin/start-server.sh
              perl -i -pe 'print "JAVA_HOME=$JAVA_HOME_8_${{ runner.arch }}\n" if $. == 20' sbin/start-cli.sh

        - name: Add JAVA_HOME of Java 8 to IoTDB Scripts
          if: runner.os == 'Windows'
          shell: bash
          working-directory: ${{ steps.base.outputs.tool-path }}
          run: |
              perl -i -pe 'print "set JAVA_HOME=%JAVA_HOME_8_${{ runner.arch }}%\n" if $. == 20' sbin/start-server.bat
              perl -i -pe 'print "set JAVA_HOME=%JAVA_HOME_8_${{ runner.arch }}%\n" if $. == 20' sbin/start-cli.bat
